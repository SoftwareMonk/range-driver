

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Downloading Nemo Data &mdash; Range Driver 0.0.dev1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "document", "processHtmlClass": "math|output_area"}}</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Range Driver
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tutorials</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/index.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Range Driver</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Downloading Nemo Data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/tutorials/NSOG_Jan2018/NEMO_Data_Collection.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Downloading-Nemo-Data">
<h1>Downloading Nemo Data<a class="headerlink" href="#Downloading-Nemo-Data" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference external" href="https://salishsea.eos.ubc.ca/nemo/#">SalishSeaCast</a> project provides access to their model forecasts and historic model results through their <a class="reference external" href="https://salishsea.eos.ubc.ca/erddap/index.html">ERDDAP</a> server. This data does cover the time &amp; geospatial bounds we are using for the NSOG range test.</p>
<p>The granularity of this data is fine. Grid positions are <em>very</em> close to one another &amp; most of the historic variables have been retained at hourly intervals.</p>
<p>One trick with this data is that the environmental data itself doesn’t include lat/lon coordinates. Instead, these files contain <code class="docutils literal notranslate"><span class="pre">gridX</span></code>/<code class="docutils literal notranslate"><span class="pre">gridY</span></code> coordinates. To find the corresponding lat/lon coordinates you have to use the <a class="reference external" href="https://salishsea.eos.ubc.ca/erddap/griddap/ubcSSnBathymetryV17-02.html">geolocation and bathymetry data</a>. This dataset contains the lat, lon, and maximum depth at each gridX &amp; gridY coordinate. The key here is that you must match the entire gridX/gridY coordinate to
get either gridX. In other words (or an equation) <code class="docutils literal notranslate"><span class="pre">lat</span> <span class="pre">=</span> <span class="pre">f(gridX,</span> <span class="pre">gridY)</span></code>.</p>
<p>One solution to this, is to merge the environmental variable &amp; geolocation data &amp; save that to a netCDF file for <code class="docutils literal notranslate"><span class="pre">range_driver</span></code> to ingest. However, if you re-index the XArray –</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">range_driver</span> <span class="k">as</span> <span class="nn">at</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">ipyleaflet</span> <span class="kn">import</span> <span class="n">Map</span><span class="p">,</span> <span class="n">Marker</span><span class="p">,</span> <span class="n">Rectangle</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
//anaconda3/envs/range-driver/lib/python3.8/site-packages/kadlu/geospatial/data_sources/data_util.py:44: UserWarning: storage location not configured. storage location will be set to /Users/jilliana/kadlu_data/
  warnings.warn(f&#39;{msg} storage location will be set to {storage_location}&#39;)
//anaconda3/envs/range-driver/lib/python3.8/site-packages/kadlu/geospatial/data_sources/data_util.py:44: UserWarning: storage location not configured. storage location will be set to /Users/jilliana/kadlu_data/
  warnings.warn(f&#39;{msg} storage location will be set to {storage_location}&#39;)
</pre></div></div>
</div>
</div>
<div class="section" id="Load-Config-File">
<h1>Load Config File<a class="headerlink" href="#Load-Config-File" title="Permalink to this headline">¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Read Config File</span>
<span class="n">baseconfig</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">yload</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s2">&quot;configs/base_config.yaml&quot;</span><span class="p">))</span>
<span class="n">viewconfig</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">yload</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s2">&quot;configs/view_config.yaml&quot;</span><span class="p">))</span>
<span class="n">at</span><span class="o">.</span><span class="n">deep_update</span><span class="p">(</span><span class="n">baseconfig</span><span class="p">,</span> <span class="n">viewconfig</span><span class="p">)</span>
<span class="n">rawconfig</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">yload</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s2">&quot;configs/nsog_jan2018_config.yaml&quot;</span><span class="p">))</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">(</span><span class="n">baseconfig</span><span class="p">,</span> <span class="n">rawconfig</span><span class="p">)</span>
<span class="n">at</span><span class="o">.</span><span class="n">prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>


<span class="c1"># Update our bounds for custom download</span>
<span class="c1"># (Optional -- done b/c this dataset is so fine grained)</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;north&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;lat_center&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.015</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;south&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;lat_center&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.015</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;east&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;lon_center&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;west&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;lon_center&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.03</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2018-01-01&#39;</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2018-02-01&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Load-the-Bathymetry-Data">
<h1>Load the Bathymetry Data<a class="headerlink" href="#Load-the-Bathymetry-Data" title="Permalink to this headline">¶</a></h1>
<p>The next thing we need to do is read in the region information file for the full NEMO dataset. This will provide the mapping from (gridX, gridY) position to (lon, lat) coordinates. As well, the bathymetry data in the file, will let us refine the range of depths we collect the environmental data for.</p>
<p>The function below will look for the file on disk. If it doesn’t find it, it will download the bathy file from the <a class="reference external" href="https://salishsea.eos.ubc.ca/erddap/griddap/ubcSSnBathymetryV17-02.html">SalishSeaCast ERDDAP</a> server.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">read_nemo_region</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">allow_download</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bathy_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">allow_download</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found at filepath. Downloading file to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://salishsea.eos.ubc.ca/erddap/griddap/ubcSSnBathymetryV17-02.nc?bathymetry[(0.0):1:(897.0)][(0.0):1:(397.0)],latitude[(0.0):1:(897.0)][(0.0):1:(397.0)],longitude[(0.0):1:(897.0)][(0.0):1:(397.0)]&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">bathy_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span>
    <span class="k">return</span> <span class="n">bathy_xr</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nemo_bathy_loc</span> <span class="o">=</span> <span class="s1">&#39;data/SalishSeaCast/ubcSSnBathymetryV17-02_a29d_efc9_4047.nc&#39;</span>
<span class="n">bathy_xr</span> <span class="o">=</span> <span class="n">read_nemo_region</span><span class="p">(</span><span class="n">nemo_bathy_loc</span><span class="p">,</span> <span class="n">allow_download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">bathy_df</span> <span class="o">=</span> <span class="n">bathy_xr</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">no_nans</span> <span class="o">=</span> <span class="n">bathy_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">no_nans</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span> <span class="n">no_nans</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PathCollection at 0x16c6de6d0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_NSOG_Jan2018_NEMO_Data_Collection_7_1.png" src="../../_images/tutorials_NSOG_Jan2018_NEMO_Data_Collection_7_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">bathy_xr</span><span class="p">[</span><span class="s1">&#39;bathymetry&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.QuadMesh at 0x16e11acd0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_NSOG_Jan2018_NEMO_Data_Collection_8_1.png" src="../../_images/tutorials_NSOG_Jan2018_NEMO_Data_Collection_8_1.png" />
</div>
</div>
</div>
<div class="section" id="Find-ERDDAP-Bounds">
<h1>Find ERDDAP Bounds<a class="headerlink" href="#Find-ERDDAP-Bounds" title="Permalink to this headline">¶</a></h1>
<p>Next, we need to figure out what bounds we will use when we retreieve environmental data from the ERDDAP server. The trick here is that the ERDDAP server doesn’t use lon/lat boundaries, but instead uses gridX/gridY boundaries. We will use the bathymetry dataset we downloaded previously to determine what boundaries we will use when querying the ERDDAP servers.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">find_erddap_bounds</span><span class="p">(</span><span class="n">bathy_data</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">in_bounds</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span> <span class="o">&amp;</span> \
               <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span> <span class="o">&amp;</span> \
               <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span> <span class="o">&amp;</span> \
               <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>

    <span class="n">filtered</span> <span class="o">=</span> <span class="n">bathy_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">in_bounds</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">gridX</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="s1">&#39;gridX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
    <span class="n">gridX_min</span> <span class="o">=</span> <span class="n">gridX</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">gridX_max</span> <span class="o">=</span> <span class="n">gridX</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">gridY</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="s1">&#39;gridY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
    <span class="n">gridY_min</span> <span class="o">=</span> <span class="n">gridY</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">gridY_max</span> <span class="o">=</span> <span class="n">gridY</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">depth</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="s1">&#39;bathymetry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
    <span class="n">depth_min</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">depth_max</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">((</span><span class="n">gridX_min</span><span class="p">,</span> <span class="n">gridX_max</span><span class="p">),</span>
            <span class="p">(</span><span class="n">gridY_min</span><span class="p">,</span> <span class="n">gridY_max</span><span class="p">),</span>
            <span class="p">(</span><span class="n">depth_min</span><span class="p">,</span> <span class="n">depth_max</span><span class="p">))</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Map lon/lat bounds to gridX, gridY, and depth bounds</span>
<span class="n">bounds_gridX</span><span class="p">,</span> <span class="n">bounds_gridY</span><span class="p">,</span> <span class="n">bounds_depth</span> <span class="o">=</span> <span class="n">find_erddap_bounds</span><span class="p">(</span><span class="n">bathy_xr</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Download">
<h1>Download<a class="headerlink" href="#Download" title="Permalink to this headline">¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://salishsea.eos.ubc.ca/erddap/griddap/&quot;</span>


<span class="k">def</span> <span class="nf">download_nemo_variable</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://salishsea.eos.ubc.ca/erddap/griddap/&quot;</span>
    <span class="n">ftype</span> <span class="o">=</span> <span class="s1">&#39;nc&#39;</span>

    <span class="c1"># Time Filter</span>
    <span class="n">time_stride</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_filter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[(</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">):</span><span class="si">{</span><span class="n">time_stride</span><span class="si">}</span><span class="s2">:(</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)]&quot;</span>

    <span class="c1"># depth Filter</span>
    <span class="n">depth_stride</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">depth_filter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[(</span><span class="si">{</span><span class="n">bounds_depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">):</span><span class="si">{</span><span class="n">depth_stride</span><span class="si">}</span><span class="s2">:(</span><span class="si">{</span><span class="n">bounds_depth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)]&quot;</span>

    <span class="c1"># gridY Filter</span>
    <span class="n">gridY_stride</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">gridY_filter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[(</span><span class="si">{</span><span class="n">bounds_gridY</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">):</span><span class="si">{</span><span class="n">gridY_stride</span><span class="si">}</span><span class="s2">:(</span><span class="si">{</span><span class="n">bounds_gridY</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)]&quot;</span>

    <span class="c1"># gridX Filter</span>
    <span class="n">gridX_stride</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">gridX_filter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[(</span><span class="si">{</span><span class="n">bounds_gridX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">):</span><span class="si">{</span><span class="n">gridX_stride</span><span class="si">}</span><span class="s2">:(</span><span class="si">{</span><span class="n">bounds_gridX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)]&quot;</span>

    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">variable</span><span class="si">}{</span><span class="n">time_filter</span><span class="si">}{</span><span class="n">depth_filter</span><span class="si">}{</span><span class="n">gridY_filter</span><span class="si">}{</span><span class="n">gridX_filter</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Something went wrong. </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2"> data couldn&#39;t be downloaded.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">url</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success! </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2"> data been downloaded.&quot;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">url</span>

</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_output_path</span> <span class="o">=</span> <span class="s1">&#39;data/NEMO/&#39;</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">{</span>
             <span class="s2">&quot;uVelocity&quot;</span><span class="p">:</span> <span class="s2">&quot;ubcSSg3DuGridFields1hV19-05&quot;</span><span class="p">,</span>
             <span class="s2">&quot;vVelocity&quot;</span><span class="p">:</span> <span class="s2">&quot;ubcSSg3DvGridFields1hV19-05&quot;</span><span class="p">,</span>
             <span class="s2">&quot;wVelocity&quot;</span><span class="p">:</span> <span class="s2">&quot;ubcSSg3DwGridFields1hV19-05&quot;</span><span class="p">,</span>
             <span class="s2">&quot;salinity&quot;</span><span class="p">:</span> <span class="s2">&quot;ubcSSg3DTracerFields1hV19-05&quot;</span><span class="p">,</span>
             <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="s2">&quot;ubcSSg3DTracerFields1hV19-05&quot;</span><span class="p">,</span>
             <span class="s2">&quot;fraserTurbidity&quot;</span><span class="p">:</span> <span class="s2">&quot;ubcSSg3DAuxiliaryFields1hV19-05&quot;</span><span class="p">,</span>
             <span class="s2">&quot;mesozooplankton&quot;</span><span class="p">:</span> <span class="s2">&quot;ubcSSg3DBiologyFields1hV19-05&quot;</span><span class="p">,</span>
             <span class="s2">&quot;microzooplankton&quot;</span><span class="p">:</span> <span class="s2">&quot;ubcSSg3DBiologyFields1hV19-05&quot;</span>
            <span class="p">}</span>

<span class="n">ftype</span> <span class="o">=</span> <span class="s2">&quot;nc&quot;</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">tab</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
<span class="n">yaml</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">file_map:</span><span class="se">\n</span><span class="si">{</span><span class="n">tab</span><span class="si">}</span><span class="s2">data_dir: &#39;</span><span class="se">{{</span><span class="s2">repo_path</span><span class="se">}}</span><span class="s2">/</span><span class="si">{</span><span class="n">data_output_path</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
    <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>


    <span class="c1"># TODO: Add a check if the data already exists on disk before downloading it.</span>
    <span class="c1"># Download the data</span>
    <span class="n">var_data</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="n">download_nemo_variable</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">)</span>

    <span class="c1"># Merge the variable data with the bathymetry data to get lat/lon</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">var_data</span><span class="p">,</span> <span class="n">bathy_xr</span><span class="p">],</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>\
               <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;lon&#39;</span><span class="p">})</span>

    <span class="c1"># Write the data to a NetCDF File</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./data/NEMO/&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">file_name</span>
    <span class="n">merged</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>

    <span class="c1"># Add dataset to datasets dict</span>
    <span class="n">datasets</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="c1"># Add to the yaml example</span>
    <span class="n">yaml</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tab</span><span class="si">}{</span><span class="n">variable</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Success! fraserTurbidity data been downloaded.
Success! mesozooplankton data been downloaded.
Success! microzooplankton data been downloaded.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Add the following lines to your config.yaml file:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Add the following lines to your config.yaml file:

file_map:
  data_dir: &#39;{repo_path}/data/NEMO/&#39;
  fraserTurbidity: fraserTurbidity_2018-01-01_2018-02-01.nc
  mesozooplankton: mesozooplankton_2018-01-01_2018-02-01.nc
  microzooplankton: microzooplankton_2018-01-01_2018-02-01.nc

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, SFU.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>